name: CI

on:
  pull_request:
    branches:
      - master
      - main
      - develop
  push:
    branches:
      - develop

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        bun-version: [latest]
        node-version: [18, 20, 22]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ matrix.bun-version }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linter
        run: bun run lint

      - name: Run formatter check
        run: bun run fmt --check

      - name: Run type check
        run: bun run typecheck

      - name: Run tests
        run: bun run test:run

      - name: Build package
        run: bun run build

      - name: Check build artifacts
        run: |
          if [ ! -f "dist/index.cjs" ] || [ ! -f "dist/index.mjs" ] || [ ! -f "dist/index.d.ts" ]; then
            echo "âŒ Build artifacts missing!"
            exit 1
          fi
          echo "âœ… All build artifacts present"

      - name: Upload coverage
        if: matrix.node-version == 20
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  size-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build package
        run: bun run build

      - name: Check bundle size
        run: |
          ESM_SIZE=$(stat -f%z "dist/index.mjs" 2>/dev/null || stat -c%s "dist/index.mjs")
          CJS_SIZE=$(stat -f%z "dist/index.cjs" 2>/dev/null || stat -c%s "dist/index.cjs")
          TOTAL_SIZE=$((ESM_SIZE + CJS_SIZE))

          echo "## ðŸ“¦ Bundle Size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Format | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESM | $(numfmt --to=iec-i --suffix=B $ESM_SIZE) |" >> $GITHUB_STEP_SUMMARY
          echo "| CJS | $(numfmt --to=iec-i --suffix=B $CJS_SIZE) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$(numfmt --to=iec-i --suffix=B $TOTAL_SIZE)** |" >> $GITHUB_STEP_SUMMARY

          # Fail if bundle is too large (adjust threshold as needed)
          if [ $TOTAL_SIZE -gt 50000 ]; then
            echo "âš ï¸ Bundle size exceeds 50KB threshold" >> $GITHUB_STEP_SUMMARY
          fi

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
